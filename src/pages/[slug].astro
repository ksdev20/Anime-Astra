---
import CategorySection from "../components/BlogCard/CategorySection";
import { Blogs } from "../data/Blogs";
import Layout from "../layouts/Layout.astro";
import "../styles/pages/blog-page.css";
import { Creators } from "../data/Creators";
import TocSection from "../components/BlogPage/TocSection.astro";
import NextPrevPosts from "../components/BlogPage/NextPrevPosts.astro";
import CreatorSection from "../components/BlogPage/CreatorSection.astro";
import ShareSection from "../components/BlogPage/ShareSection.astro";
import HomeSection from "../components/HomePage/HomeSection.astro";
import CommentSection from "../components/BlogPage/CommentSection/CommentSection.js";
import AnimeObject from "../components/AnimeObject/AnimeObject.astro";

const { slug } = Astro.params;
const postUrl = Astro.request.url;
const blogObj = Blogs.find((i) => i.slug == slug);
if (!slug || !blogObj) {
  return new Response(null, {
    status: 302,
    headers: {
      Location: "/404",
    },
  });
}

const {
  title,
  author,
  date,
  readMinutes,
  categoryList,
  img,
  imgLarge,
  toc,
  nextPost,
  previousPost,
  animeObjects,
} = blogObj;

const { description, keywords, imageUrl } = blogObj; //For Page Head

if (!animeObjects) return null;
const creatorObj = Creators.find((i) => i.name == author);
const creatorLink = "/creator/" + author;

const pageHead = {
  title: title + " | Anime Astra",
  description,
  keywords,
  url: postUrl,
  imageUrl,
  author,
};
---

<Layout pageHead={pageHead} forPage="blog">
  <header aria-label="Article Header" class="bp-header">
    <h1 class="bp-h1">{title}</h1>
    <ul class="bph-details">
      <li>by <a href={creatorLink} class="hov-ul">{author}</a></li>
      <li>
        <time datetime={date}>• {date}</time>
      </li>
      <li>• {readMinutes} Minutes</li>
    </ul>
    <CategorySection categoryList={categoryList} />
  </header>
  <picture>
    <source media="(max-width: 640px)" srcset={img} type="img/jpeg" />
    <source media="(min-width: 641px)" srcset={imgLarge} type="img/jpeg" />
    <img
      src={imgLarge}
      alt={`Image for blog titled ${title}`}
      class="bp-main-img"
      loading="eager"
      fetchpriority="high"
    />
  </picture>
  <div id="toc"></div>
  <TocSection toc={toc} />
  <a href="#toc" class="toc-sticky category-span">TOC</a>
  <div class="anime-objects">
    {animeObjects.map((obj, i) => <AnimeObject animeObj={obj} i={i} />)}
  </div>
  <NextPrevPosts next={nextPost} prev={previousPost} />
  <CreatorSection creatorObj={creatorObj} />
  <ShareSection postSlug={slug} postTitle={title} postUrl={postUrl} />
  <HomeSection
    sectionName={categoryList[0]}
    customId="related-posts"
    customHeading="Related Posts"
    exclude={title}
  />
  <CommentSection slug={slug} client:load />
</Layout>
